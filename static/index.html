<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aviso Data Cleaner</title>
    <style>
        :root { --primary: #6C62D4; --bg: #F3F4F6; --white: #FFF; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; align-items: center; }
        
        header { background: var(--primary); color: white; width: 100%; padding: 1rem; text-align: center; }
        
        .container { width: 90%; max-width: 900px; margin-top: 2rem; }
        
        /* CARD STYLES */
        .card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 1.5rem; }
        .card h2 { margin-top: 0; color: #333; font-size: 1.2rem; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        /* DB STATS */
        .stats-grid { display: flex; gap: 20px; }
        .stat-box { background: #f8f9fa; padding: 10px; border-radius: 5px; flex: 1; text-align: center; }
        .stat-val { font-size: 1.5rem; font-weight: bold; color: var(--primary); }

        /* UPLOAD ZONE */
        .upload-zone { border: 2px dashed #ccc; padding: 2rem; text-align: center; cursor: pointer; transition: 0.2s; }
        .upload-zone:hover { border-color: var(--primary); background: #f0f0ff; }
        
        /* TABLE STYLES */
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; font-size: 0.9rem; }
        th { background: #f1f1f1; }
        
        .score-high { color: green; font-weight: bold; }
        .score-low { color: red; font-weight: bold; }
        
        /* BUTTONS */
        .btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .actions { margin-top: 20px; text-align: right; display: none; }
    </style>
</head>
<body>

    <header>
        <h1>Aviso Intelligent Data Cleaner</h1>
    </header>

    <div class="container">
        
        <div class="card">
            <h2>üìÇ Active Reference Database</h2>
            <div class="stats-grid">
                <div class="stat-box">
                    <div>File Name</div>
                    <div class="stat-val" id="dbName">Loading...</div>
                </div>
                <div class="stat-box">
                    <div>Total Records</div>
                    <div class="stat-val" id="dbCount">...</div>
                </div>
            </div>
            <div style="margin-top:10px; font-size:0.8rem; color:#666;">
                *This is the "Clean" source of truth we match against.
            </div>
        </div>

        <div class="card">
            <h2>üßπ Upload Messy File</h2>
            <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                <p>Click to Upload <b>.csv</b> File</p>
                <input type="file" id="fileInput" accept=".csv" style="display:none" onchange="handleUpload()">
            </div>
        </div>

        <div class="card" id="resultsCard" style="display:none;">
            <h2>üìù Review Suggestions</h2>
            <div style="max-height: 400px; overflow-y: auto;">
                <table id="resultsTable">
                    <thead>
                        <tr>
                            <th>Original Input</th>
                            <th>AI Suggested Match</th>
                            <th>Score</th>
                            <th>Accept Change?</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <div class="actions" style="display:block;">
                <button class="btn-outline" onclick="location.reload()">Discard</button>
                <button class="btn" onclick="exportCleaned()">Download Cleaned CSV</button>
            </div>
        </div>

    </div>

    <script>
        // 1. Load Database Info on Start
        fetch('/db-info')
            .then(r => r.json())
            .then(data => {
                document.getElementById('dbName').innerText = data.filename;
                document.getElementById('dbCount').innerText = data.total_records;
            });

        // 2. Handle File Upload
        async function handleUpload() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            // Show loading...
            document.querySelector('.upload-zone p').innerText = "Processing AI Model...";

            const res = await fetch('/upload-csv', { method: 'POST', body: formData });
            const data = await res.json();
            
            renderTable(data.results);
            document.getElementById('resultsCard').style.display = 'block';
            document.querySelector('.upload-zone p').innerText = "Upload New File";
        }

        let currentData = [];

        // 3. Render the Review Table
        function renderTable(results) {
            currentData = results;
            const tbody = document.querySelector('#resultsTable tbody');
            tbody.innerHTML = '';

            results.forEach((row, index) => {
                const tr = document.createElement('tr');
                const isHigh = row.score > 0.6;
                const scoreClass = isHigh ? 'score-high' : 'score-low';
                const checked = isHigh ? 'checked' : '';

                tr.innerHTML = `
                    <td>${row.original}</td>
                    <td><b>${row.suggested_name}</b><br><small>${row.suggested_company}</small></td>
                    <td class="${scoreClass}">${(row.score * 100).toFixed(0)}%</td>
                    <td><input type="checkbox" id="check-${index}" ${checked}></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 4. Export Functionality (Client-Side)
        function exportCleaned() {
            let csvContent = "data:text/csv;charset=utf-8,Original,Cleaned_Name,Cleaned_Company\n";
            
            currentData.forEach((row, index) => {
                const isAccepted = document.getElementById(`check-${index}`).checked;
                const finalName = isAccepted ? row.suggested_name : row.original;
                const finalComp = isAccepted ? row.suggested_company : "";
                
                csvContent += `"${row.original}","${finalName}","${finalComp}"\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "aviso_cleaned_data.csv");
            document.body.appendChild(link);
            link.click();
        }
    </script>
</body>
</html>